<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Informe de Movimientos – Generador (Excel → HTML/DOCX)</title>
    <!-- Tailwind (CDN) for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for reading Excel in-browser -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
    <!-- docx for generating Word documents in-browser -->
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.js"></script>
</head>

<body class="bg-slate-50 text-slate-900">
    <div class="max-w-5xl mx-auto p-6">
        <header class="mb-6">
            <h1 class="text-2xl font-bold">Informe de Movimientos – Generador</h1>
            <p class="text-sm text-slate-600">Sube tu Excel con hojas por día, ajusta los campos y genera el informe en <span class="font-medium">HTML</span> o <span class="font-medium">Word (.docx)</span>, directamente en GitHub Pages (sin servidor).</p>
        </header>

        <section class="grid md:grid-cols-2 gap-4 mb-6">
            <div class="bg-white rounded-2xl shadow p-4">
                <div class="mb-3">
                    <label class="block text-sm font-medium">Archivo Excel</label>
                    <input id="file" type="file" accept=".xlsx,.xls" class="mt-1 block w-full text-sm" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium">Empresa</label>
                        <input id="empresa" class="mt-1 w-full rounded border border-slate-300 p-2 text-sm" value="Surtiprocesos industriales S.A.S" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Mes</label>
                        <input id="mes" class="mt-1 w-full rounded border border-slate-300 p-2 text-sm" value="Agosto de 2025" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Responsable</label>
                        <input id="responsable" class="mt-1 w-full rounded border border-slate-300 p-2 text-sm" value="(pendiente)" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Cuenta de caja</label>
                        <input id="petty" class="mt-1 w-full rounded border border-slate-300 p-2 text-sm" value="CAJA MENOR" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Mínimo transferencia (DEBE)</label>
                        <input id="minTransfer" type="number" class="mt-1 w-full rounded border border-slate-300 p-2 text-sm" value="300000" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Palabras clave transferencias</label>
                        <input id="keywords" class="mt-1 w-full rounded border border-slate-300 p-2 text-sm" value="PROVEEDOR,PROVEEDORES,BANCO,ARRIENDO,SERVICIO,SERVICIOS,PLANILLA,VEHICULO,VEHICULOS,GASOLINA,CLARO,COMPENSAR,FALABELLA,FINANDINA,DOTACION" />
                    </div>
                </div>
                <div class="mt-4 flex flex-wrap gap-3">
                    <button id="btnPreview" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm">Generar vista previa HTML</button>
                    <button id="btnDownloadHTML" class="px-4 py-2 rounded-xl border text-sm">Descargar HTML</button>
                    <button id="btnDownloadDocx" class="px-4 py-2 rounded-xl bg-blue-600 text-white text-sm">Descargar DOCX</button>
                </div>
                <p id="status" class="mt-3 text-xs text-slate-600"></p>
            </div>

            <div class="bg-white rounded-2xl shadow p-4">
                <h2 class="text-sm font-semibold mb-2">Consejos</h2>
                <ul class="list-disc ms-5 text-sm text-slate-700 space-y-1">
                    <li>Las hojas deben llamarse con fecha: <code>1-08-2025</code>, <code>04-08-2025</code>, etc.</li>
                    <li>Dentro de cada hoja, incluye columnas: <strong>CUENTA</strong>, <strong>DEBE</strong>, <strong>HABER</strong>.</li>
                    <li>Si no hay <strong>HABER</strong>, el sistema infiere transferencias por palabras clave y mínimo.</li>
                    <li>Todo se ejecuta <em>en tu navegador</em>; no sube datos a ningún servidor.</li>
                </ul>
            </div>
        </section>

        <section class="bg-white rounded-2xl shadow p-4">
            <h2 class="text-lg font-semibold mb-3">Vista previa</h2>
            <div id="report" class="prose max-w-none"></div>
        </section>
    </div>

    <script>
        const money = (x) => {
            const n = Number(x || 0);
            return isFinite(n) ? "$" + Math.round(n).toLocaleString('es-CO').replace(/\,/g, '.') : String(x);
        };
        const fmtDate = (d) => {
            const dt = new Date(d);
            const dd = String(dt.getDate()).padStart(2, '0');
            const mm = String(dt.getMonth() + 1).padStart(2, '0');
            const yyyy = dt.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        };
        const parseSheetDate = (name) => {
            const m = String(name).trim().match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
            if (!m) return null;
            const d = parseInt(m[1], 10),
                mth = parseInt(m[2], 10) - 1,
                y = parseInt(m[3], 10);
            return new Date(y, mth, d);
        };

        function detectHeaderRow(rows) {
            // Find a row that contains CUENTA & DEBE (case-insensitive)
            for (let i = 0; i < Math.min(10, rows.length); i++) {
                const r = rows[i] || [];
                const upper = r.map(v => String(v || '').toUpperCase());
                if (upper.some(v => v.includes('CUENTA')) && upper.some(v => v.includes('DEBE'))) {
                    return i;
                }
            }
            return 0;
        }

        function mapColumns(headerRow) {
            const map = {
                CUENTA: -1,
                DEBE: -1,
                HABER: -1
            };
            headerRow.forEach((v, idx) => {
                const u = String(v || '').toUpperCase();
                if (u.includes('CUENTA') && map.CUENTA === -1) map.CUENTA = idx;
                if (u.includes('DEBE') && map.DEBE === -1) map.DEBE = idx;
                if (u.includes('HABER') && map.HABER === -1) map.HABER = idx;
            });
            // Fallback to first three columns if missing
            if (map.CUENTA === -1) map.CUENTA = 0;
            if (map.DEBE === -1) map.DEBE = 1;
            if (map.HABER === -1) map.HABER = 2;
            return map;
        }

        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, {
                            type: 'array'
                        });
                        resolve(wb);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function assembleLedger(wb) {
            const all = [];
            wb.SheetNames.forEach(name => {
                const dateObj = parseSheetDate(name);
                if (!dateObj) return; // Skip sheets without date names
                const ws = wb.Sheets[name];
                const rows = XLSX.utils.sheet_to_json(ws, {
                    header: 1,
                    raw: true
                });
                if (!rows.length) return;
                const headerIdx = detectHeaderRow(rows);
                const header = rows[headerIdx] || [];
                const colMap = mapColumns(header);
                for (let i = headerIdx + 1; i < rows.length; i++) {
                    const r = rows[i] || [];
                    const cuenta = String(r[colMap.CUENTA] ? ? '').trim();
                    const debe = Number(r[colMap.DEBE] ? ? NaN);
                    const haber = Number(r[colMap.HABER] ? ? NaN);
                    if (!cuenta && !isFinite(debe) && !isFinite(haber)) continue;
                    if (cuenta.toUpperCase() === 'CUENTA') continue; // stray header
                    all.push({
                        Fecha: dateObj,
                        Cuenta: cuenta,
                        Debe: isFinite(debe) ? debe : 0,
                        Haber: isFinite(haber) ? haber : 0
                    });
                }
            });
            return all;
        }

        function groupByDate(items) {
            const map = new Map();
            for (const it of items) {
                const k = new Date(it.Fecha).toISOString().slice(0, 10);
                if (!map.has(k)) map.set(k, []);
                map.get(k).push(it);
            }
            return map; // key YYYY-MM-DD -> rows
        }

        function computeSections(all, pettyCashName, minTransferDebe, keywords) {
            const PETTY = String(pettyCashName || 'CAJA MENOR').toUpperCase();
            const anyHaber = all.some(r => (r.Haber || 0) > 0);
            const kw = keywords.map(k => k.trim().toUpperCase()).filter(Boolean);

            const retirosMap = new Map();
            const detalles = [];

            for (const row of all) {
                const isPetty = String(row.Cuenta || '').toUpperCase() === PETTY;
                if (isPetty && row.Debe > 0) {
                    const k = new Date(row.Fecha).toISOString().slice(0, 10);
                    retirosMap.set(k, (retirosMap.get(k) || 0) + row.Debe);
                } else if (row.Debe > 0) {
                    detalles.push(row);
                }
            }

            // detalles por día
            const detallesByDay = groupByDate(detalles);

            // retiros array + efectivo calc
            const retiros = [];
            for (const [k, monto] of Array.from(retirosMap.entries()).sort()) {
                const dets = detallesByDay.get(k) || [];
                const detSum = dets.reduce((a, b) => a + (b.Debe || 0), 0);
                retiros.push({
                    Fecha: new Date(k),
                    Monto: monto,
                    Concepto: 'COMPRAS',
                    Detalle_Total: detSum,
                    Efectivo: Math.round(monto - detSum)
                });
            }

            // posibles transferencias
            let posibles = [];
            if (anyHaber) {
                posibles = all.filter(r => (r.Haber || 0) > 0).map(r => ({...r,
                    Valor: r.Haber,
                    Tipo: 'HABER'
                }));
            } else {
                posibles = all.filter(r => (r.Debe || 0) >= minTransferDebe && kw.some(w => String(r.Cuenta || '').toUpperCase().includes(w))).map(r => ({...r,
                    Valor: r.Debe,
                    Tipo: 'DEBE(MAYOR)'
                }));
            }
            const transByDay = groupByDate(posibles);
            const transDiario = Array.from(transByDay.entries()).map(([k, arr]) => ({
                Fecha: new Date(k),
                Monto_Transferido: arr.reduce((a, b) => a + (b.Valor || 0), 0)
            }));
            const totalTrans = transDiario.reduce((a, b) => a + (b.Monto_Transferido || 0), 0);

            return {
                retiros,
                detallesByDay,
                posibles,
                transDiario,
                totalTrans
            };
        }

        function renderHTML(reportEl, empresa, mes, responsable, sections) {
            const today = new Date();
            const fmtLong = today.toLocaleDateString('es-CO', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            const {
                retiros,
                detallesByDay,
                posibles,
                transDiario,
                totalTrans
            } = sections;

            let html = '';
            html += `<div class="text-sm text-slate-600">Empresa: <b>${empresa}</b> · Mes: <b>${mes}</b> · Responsable: <b>${responsable || '(pendiente)'}</b> · Fecha de elaboración: ${fmtLong}</div>`;
            html += `<hr class="my-3">`;

            // Retiros
            html += `<h3 class="font-semibold">DETALLE DE RETIROS DIARIOS PARA CAJA</h3>`;
            if (retiros.length) {
                html += `<div class="overflow-x-auto"><table class="w-full text-sm border mt-2"><thead><tr class="bg-slate-100"><th class="border p-2 text-left">Fecha</th><th class="border p-2 text-left">Monto retirado</th><th class="border p-2 text-left">Concepto / Observación</th></tr></thead><tbody>`;
                for (const r of[...retiros].sort((a, b) => a.Fecha - b.Fecha)) {
                    html += `<tr><td class="border p-2">${fmtDate(r.Fecha)}</td><td class="border p-2">${money(r.Monto)}</td><td class="border p-2">${r.Concepto}</td></tr>`;
                }
                const tot = retiros.reduce((a, b) => a + (b.Monto || 0), 0);
                html += `</tbody></table></div>`;
                html += `<div class="mt-2 inline-block border rounded"><table class="text-sm"><tr><td class="border p-2 font-semibold">TOTAL CAJAS</td><td class="border p-2">${money(tot)}</td></tr></table></div>`;
            } else {
                html += `<div class="text-xs text-slate-600">No se detectaron retiros de 'CAJA MENOR'.</div>`;
            }

            // Detalles por día
            html += `<h3 class="font-semibold mt-6">DETALLES DE CAJAS MENORES POR DÍA</h3>`;
            const dias = Array.from(detallesByDay.entries()).sort(([a], [b]) => (new Date(a)) - (new Date(b)));
            if (dias.length) {
                for (const [k, sub] of dias) {
                    const sum = sub.reduce((a, b) => a + (b.Debe || 0), 0);
                    const retiroDia = sections.retiros.find(r => r.Fecha.toISOString().slice(0, 10) === new Date(k).toISOString().slice(0, 10));
                    const efectivo = retiroDia ? retiroDia.Efectivo : null;
                    html += `<div class="mt-3"><div class="font-medium">${fmtDate(new Date(k))}</div>`;
                    html += `<div class="overflow-x-auto"><table class="w-full text-sm border mt-1"><thead><tr class="bg-slate-100"><th class="border p-2 text-left">Concepto</th><th class="border p-2 text-left">Valor</th></tr></thead><tbody>`;
                    for (const row of sub.sort((a, b) => String(a.Cuenta).localeCompare(String(b.Cuenta)))) {
                        html += `<tr><td class="border p-2">${row.Cuenta}</td><td class="border p-2">${money(row.Debe)}</td></tr>`;
                    }
                    html += `<tr><td class="border p-2 font-semibold">TOTAL</td><td class="border p-2">${money(sum)}</td></tr>`;
                    if (efectivo !== null) html += `<tr><td class="border p-2 font-semibold">EFECTIVO</td><td class="border p-2">${money(efectivo)}</td></tr>`;
                    html += `</tbody></table></div></div>`;
                }
            } else {
                html += `<div class="text-xs text-slate-600">No se detectaron egresos de caja (DEBE) distintos a 'CAJA MENOR'.</div>`;
            }

            // Transferencias
            html += `<h3 class="font-semibold mt-6">DETALLES DE TRANSFERENCIAS</h3>`;
            if (transDiario.length) {
                html += `<div class="overflow-x-auto"><table class="w-full text-sm border mt-2"><thead><tr class="bg-slate-100"><th class="border p-2 text-left">Fecha</th><th class="border p-2 text-left">Monto transferido</th><th class="border p-2 text-left">Concepto / Observación</th></tr></thead><tbody>`;
                for (const r of[...transDiario].sort((a, b) => a.Fecha - b.Fecha)) {
                    html += `<tr><td class="border p-2">${fmtDate(r.Fecha)}</td><td class="border p-2">${money(r.Monto_Transferido)}</td><td class="border p-2">PROVEEDORES / GASTOS (estimado)</td></tr>`;
                }
                html += `</tbody></table></div>`;
                html += `<div class="mt-2 inline-block border rounded"><table class="text-sm"><tr><td class="border p-2 font-semibold">TOTAL</td><td class="border p-2">${money(totalTrans)}</td></tr></table></div>`;

                // 2.2 detalle por día
                html += `<div class="mt-4 font-medium">2.2 DETALLES DE TRANSFERENCIAS POR DÍA</div>`;
                const porDia = Array.from(groupByDate(possibles).entries()).sort(([a], [b]) => (new Date(a)) - (new Date(b)));
                for (const [k, arr] of porDia) {
                    html += `<div class="mt-2"><div class="font-medium">${fmtDate(new Date(k))}</div>`;
                    html += `<div class="overflow-x-auto"><table class="w-full text-sm border mt-1"><thead><tr class="bg-slate-100"><th class="border p-2 text-left">Concepto</th><th class="border p-2 text-left">Valor</th></tr></thead><tbody>`;
                    let subt = 0;
                    for (const row of arr.sort((a, b) => String(a.Cuenta).localeCompare(String(b.Cuenta)))) {
                        const val = (row.Haber && row.Haber > 0) ? row.Haber : (row.Debe || 0);
                        subt += val;
                        html += `<tr><td class="border p-2">${row.Cuenta}</td><td class="border p-2">${money(val)}</td></tr>`;
                    }
                    html += `<tr><td class="border p-2 font-semibold">TOTAL</td><td class="border p-2">${money(subt)}</td></tr>`;
                    html += `</tbody></table></div></div>`;
                }
            } else {
                html += `<div class="text-xs text-slate-600">No se detectaron transferencias claramente identificadas.</div>`;
            }

            reportEl.innerHTML = html;
        }

        async function downloadDocx(empresa, mes, responsable, sections) {
            const {
                Document,
                Packer,
                Paragraph,
                Table,
                TableRow,
                TableCell,
                TextRun,
                AlignmentType,
                WidthType
            } = docx;

            const doc = new Document({
                sections: [{
                    properties: {},
                    children: []
                }]
            });
            const children = doc.sections[0].children;

            // Helper creators
            const p = (text, opts = {}) => new Paragraph({
                children: [new TextRun({
                    text,
                    bold: !!opts.bold
                })]
            });
            const tcell = (text) => new TableCell({
                children: [p(text)]
            });
            const table = (rows) => new Table({
                width: {
                    size: 100,
                    type: WidthType.PERCENTAGE
                },
                rows: rows.map(r => new TableRow({
                    children: r.map(c => tcell(String(c)))
                }))
            });

            // Header table
            const today = new Date();
            const dateStr = today.toLocaleDateString('es-CO');
            children.push(table([
                ['Empresa', empresa],
                ['Mes', mes],
                ['Responsable', responsable || '(pendiente)'],
                ['Fecha de elaboración', dateStr]
            ]));
            children.push(p(''));

            // Retiros
            children.push(p('DETALLE DE RETIROS DIARIOS PARA CAJA', {
                bold: true
            }));
            const r = sections.retiros;
            if (r.length) {
                const rows = [
                    ['Fecha', 'Monto retirado', 'Concepto / Observación']
                ];
                [...r].sort((a, b) => a.Fecha - b.Fecha).forEach(x => rows.push([fmtDate(x.Fecha), money(x.Monto), 'COMPRAS']));
                children.push(table(rows));
                const tot = r.reduce((a, b) => a + (b.Monto || 0), 0);
                children.push(table([
                    ['TOTAL CAJAS', money(tot)]
                ]));
            } else {
                children.push(p("No se detectaron retiros de 'CAJA MENOR'."));
            }
            children.push(p(''));

            // Detalles por día
            children.push(p('DETALLES DE CAJAS MENORES POR DÍA', {
                bold: true
            }));
            const dias = Array.from(sections.detallesByDay.entries()).sort(([a], [b]) => (new Date(a)) - (new Date(b)));
            if (dias.length) {
                for (const [k, arr] of dias) {
                    children.push(p(fmtDate(new Date(k)), {
                        bold: true
                    }));
                    const rows = [
                        ['Concepto', 'Valor']
                    ];
                    arr.sort((a, b) => String(a.Cuenta).localeCompare(String(b.Cuenta))).forEach(x => rows.push([x.Cuenta, money(x.Debe)]));
                    const sum = arr.reduce((a, b) => a + (b.Debe || 0), 0);
                    rows.push(['TOTAL', money(sum)]);
                    const retiroDia = sections.retiros.find(z => z.Fecha.toISOString().slice(0, 10) === new Date(k).toISOString().slice(0, 10));
                    if (retiroDia) rows.push(['EFECTIVO', money(retiroDia.Efectivo)]);
                    children.push(table(rows));
                    children.push(p(''));
                }
            } else {
                children.push(p("No se detectaron egresos de caja (DEBE) distintos a 'CAJA MENOR'."));
            }

            // Transferencias
            children.push(p('DETALLES DE TRANSFERENCIAS', {
                bold: true
            }));
            const td = sections.transDiario;
            if (td.length) {
                const rows = [
                    ['Fecha', 'Monto transferido', 'Concepto / Observación']
                ];
                [...td].sort((a, b) => a.Fecha - b.Fecha).forEach(x => rows.push([fmtDate(x.Fecha), money(x.Monto_Transferido), 'PROVEEDORES / GASTOS (estimado)']));
                children.push(table(rows));
                children.push(table([
                    ['TOTAL', money(sections.totalTrans)]
                ]));
                children.push(p('2.2 DETALLES DE TRANSFERENCIAS POR DÍA', {
                    bold: true
                }));
                const porDia = Array.from(groupByDate(sections.possibles).entries()).sort(([a], [b]) => (new Date(a)) - (new Date(b)));
                for (const [k, arr] of porDia) {
                    children.push(p(fmtDate(new Date(k)), {
                        bold: true
                    }));
                    const rows = [
                        ['Concepto', 'Valor']
                    ];
                    let subt = 0;
                    arr.sort((a, b) => String(a.Cuenta).localeCompare(String(b.Cuenta))).forEach(x => {
                        const val = (x.Haber && x.Haber > 0) ? x.Haber : (x.Debe || 0);
                        subt += val;
                        rows.push([x.Cuenta, money(val)]);
                    });
                    rows.push(['TOTAL', money(subt)]);
                    children.push(table(rows));
                }
            } else {
                children.push(p('No se detectaron transferencias claramente identificadas.'));
            }

            const blob = await Packer.toBlob(doc);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `informe_movimientos_tablas.docx`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        function downloadHTML(html, nombre = 'informe_movimientos.html') {
            const blob = new Blob([`<!doctype html><html lang=\"es\"><meta charset=\"utf-8\"><title>Informe</title><body>${html}</body></html>`], {
                type: 'text/html;charset=utf-8'
            });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = nombre;
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        // UI handlers
        const el = {
            file: document.getElementById('file'),
            empresa: document.getElementById('empresa'),
            mes: document.getElementById('mes'),
            responsable: document.getElementById('responsable'),
            petty: document.getElementById('petty'),
            minTransfer: document.getElementById('minTransfer'),
            keywords: document.getElementById('keywords'),
            btnPreview: document.getElementById('btnPreview'),
            btnDownloadHTML: document.getElementById('btnDownloadHTML'),
            btnDownloadDocx: document.getElementById('btnDownloadDocx'),
            status: document.getElementById('status'),
            report: document.getElementById('report')
        };

        let cachedSections = null;

        async function buildSections() {
            el.status.textContent = '';
            const file = el.file.files && el.file.files[0];
            if (!file) {
                el.status.textContent = 'Selecciona un archivo Excel primero.';
                return null;
            }
            const wb = await readExcel(file);
            const all = assembleLedger(wb);
            if (!all.length) {
                el.status.textContent = 'No se hallaron hojas con nombre de fecha o filas válidas.';
                return null;
            }
            const keywords = el.keywords.value.split(',');
            const sections = computeSections(all, el.petty.value, Number(el.minTransfer.value || 0), keywords);
            cachedSections = sections;
            return sections;
        }

        el.btnPreview.addEventListener('click', async() => {
            const sec = await buildSections();
            if (!sec) return;
            renderHTML(el.report, el.empresa.value, el.mes.value, el.responsable.value, sec);
        });

        el.btnDownloadHTML.addEventListener('click', async() => {
            if (!cachedSections) {
                const sec = await buildSections();
                if (!sec) return;
            }
            // Build preview HTML from cachedSections
            const tmp = document.createElement('div');
            renderHTML(tmp, el.empresa.value, el.mes.value, el.responsable.value, cachedSections);
            downloadHTML(tmp.innerHTML, 'informe_movimientos_tablas.html');
        });

        el.btnDownloadDocx.addEventListener('click', async() => {
            if (!cachedSections) {
                const sec = await buildSections();
                if (!sec) return;
            }
            await downloadDocx(el.empresa.value, el.mes.value, el.responsable.value, cachedSections);
        });
    </script>
</body>

</html>